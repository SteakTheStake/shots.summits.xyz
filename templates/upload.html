{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <article class="col-md-8 round border small-blur" style="background-color: #ffffff05;">
            <div class="text-light">
                <div class="card-header">
                    <h4 class="mb-0 styled_font">Upload A Screenshot</h4>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    <form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
                        <div class="form-group">
                            <label class="font-weight-bold large-text" for="discord_username">Screenshot Taker's Discord Username</label>
                            <div class="field textarea bg-dark label prefix border round min show-overflow">
                                <input type="text"
                                    class="form-control bg-dark text-light field textarea bg-dark border round min"
                                    data-lt-tmp-id="lt-517853"
                                    spellcheck="false"
                                    data-gramm="false"
                                    id="discord_username"
                                    name="discord_username"
                                    placeholder="Discord Username"
                                    required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="font-weight-bold large-text" for="preset_name">Presets Used</label>
                            <div class="field textarea bg-dark label prefix border round min show-overflow">
                                <input type="check"
                                    class="form-control bg-dark text-light field textarea bg-dark border round min"
                                    data-lt-tmp-id="lt-517853"
                                    spellcheck="false"
                                    data-gramm="false"
                                    id="preset_name"
                                    name="preset_name"
                                    placeholder="List one or more preset names in your upload (comma separated)"
                                    required>
                            </div>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label class="font-weight-bold large-text" for="group_name"><div class="text-nowrap">Image Title</div></label>
                            <input type="text" 
                                class="form-control bg-dark text-light field textarea bg-dark border round min" 
                                id="group_name" 
                                name="group_name"
                                placeholder="Enter a group name"
                                required>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label class="font-weight-bold large-text" for="tags"><div class="text-nowrap">Features &amp; Details Tags <muted class="text-muted medium-text">(Optional)</muted></div></label>
                            <input type="text" 
                                class="form-control bg-dark text-light field textarea bg-dark border round min" 
                                id="tags" 
                                name="tags"
                                placeholder="NVE, QuantV, FiveM, Single Player (comma separated)">
                        </div>
                        
                        <div class="form-group mt-3 no-scroll">
                            <label for="screenshots" class="responsive secondary-container border drophere">Select Images</label>
                            <input type="file" 
                                class="form-control bg-dark text-light mt-4 rounded border dot_this cursor_pointer" 
                                id="screenshots" 
                                name="screenshots[]" 
                                Single 
                                accept=".png,.jpg,.jpeg,.webp,.gif"
                                required>
                        </div>
                        <p class="text-muted">Supported formats: PNG, JPG, JPEG, WEBP, GIF, Max 10MB per Image</p>
                        <progress class="align-content-center bottom-margin top-margin large-margin" value="0" max="100"></progress>
                        <button type="submit" class="responsive fill round border" id="submitButton">
                            <i class="no-round me-2">upload</i>Upload Screenshots
                        </button>
                        <div id="preview" class="mt-3">
                            <!-- Previews will appear here -->
                        </div>
                    </form>
                </div>
            </div>
        </article>
    </div>
</div>

<script>
document.getElementById('screenshots').addEventListener('change', function(e) {
    const preview = document.getElementById('preview');
    preview.innerHTML = ''; // Clear existing previews
    
    for (const file of this.files) {
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <img src="${e.target.result}" 
                        alt="Preview" 
                        style="max-height: 200px; max-width: 100%; object-fit: contain;">
                `;
                preview.appendChild(div);
            }
            reader.readAsDataURL(file);
        }
    }
});

// Get the form, progress bar and submit button elements
const uploadForm = document.querySelector('form');
const progressBar = document.querySelector('progress');
const submitButton = document.querySelector('#submitButton');

// Initially hide the progress bar
progressBar.style.display = 'none';

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    // Show progress bar and disable submit button
    progressBar.style.display = 'block';
    submitButton.disabled = true;

    // Create FormData object
    const formData = new FormData(uploadForm);
    try {
        const response = await fetch(uploadForm.action, {
            method: 'POST',
            body: formData,
            // This allows us to track upload progress
            onUploadProgress: (progressEvent) => {
                const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                progressBar.value = percentCompleted;
                progressBar.max = 100;
            }
        });
        if (response.ok) {
            // Handle successful upload
            console.log('Upload successful!');
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        // Hide progress bar and re-enable submit button
        progressBar.style.display = 'none';
        submitButton.disabled = false;
    }
});
</script>
<script>
const uploadForm = new Dropzone("#uploadForm", {
    url: "{{ url_for('upload') }}",
    paramName: "screenshots[]",
    maxFiles: 10,
    maxFilesize: 6,
    acceptedFiles: ".png,.jpg,.jpeg,.webp,.gif",
    autoProcessQueue: false,
    uploadMultiple: true,
    createImageThumbnails: true,
    
    init: function() {
        const submitButton = document.getElementById('submitButton');
        const myDropzone = this;

        // Enable submit button when files are added
        this.on("addedfile", function() {
            if (this.files.length > 0) {
                submitButton.disabled = false;
            }
        });
        
        // Disable submit button when all files are removed
        this.on("removedfile", function() {
            if (this.files.length === 0) {
                submitButton.disabled = true;
            }
        });
        
        // Handle form submission
        document.getElementById('uploadForm').addEventListener("submit", function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Validate form
            const username = document.getElementById('discord_username').value;
            if (!username) {
                alert('Please enter your Discord username');
                return;
            }
            
            if (myDropzone.files.length === 0) {
                alert('Please add at least one file');
                return;
            }
            
            myDropzone.processQueue();
        });

        // Success handling
        this.on("success", function(files, response) {
            if (response.success) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.textContent = response.message;
                document.querySelector('.card-body').insertBefore(alert, document.querySelector('form'));
                
                // Reset form after success
                setTimeout(() => {
                    this.removeAllFiles();
                    document.getElementById('uploadForm').reset();
                    alert.remove();
                    submitButton.disabled = true;
                }, 2000);
            }
        });
        
        this.on("error", function(file, message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.textContent = message;
            document.querySelector('.card-body').insertBefore(alert, document.querySelector('form'));
        });
        
        this.on("addedfile", function(file) {
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('preview');
                preview.innerHTML = `<img src="${e.target.result}" class="img-fluid" alt="Preview">`;
            }
            reader.readAsDataURL(file);
        });
    }
});
</script>
{% endblock %}
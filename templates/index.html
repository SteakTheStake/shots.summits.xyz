{% extends "base.html" %}
{% block content %}

<!-- Modal for Tag & User Selection with Search and Deselect All -->
<div class="modal fade" id="tagModal" tabindex="-1" role="dialog" aria-labelledby="tagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal_centered modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="tagModalLabel">Select Filters</h5>
        <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Tag Filter Section -->
        <div class="form-group">
          <label class="text-light">Filter by Tags</label>
          <input type="text" id="tagSearch" class="form-control" placeholder="Search tags..." />
          <div class="mt-2">
            <button type="button" class="btn btn-primary btn-sm" id="saveFilterSelection">Done</button>
            <button type="button" class="btn btn-secondary btn-sm" id="deselectAllBtn">Deselect All</button>
          </div>
        </div>
        <!-- Container for Tag Bubbles -->
        <div id="tagBubbleContainer" class="d-flex flex-wrap mb-3"></div>

        <hr class="bg-light" />

        <!-- User Filter Section -->
        <div class="form-group">
          <label class="text-light">Filter by User</label>
          <input type="text" id="userSearch" class="form-control" placeholder="Search users..." />
        </div>
        <!-- Container for User Bubbles -->
        <div id="userBubbleContainer" class="d-flex flex-wrap"></div>
      </div>
    </div>
  </div>
</div>

<!-- Filter Menu Section -->
<div class="filter-menu">
  <div class="filter-section">
    <!-- Hidden inputs to store selected tag IDs and selected user -->
    <input type="hidden" id="selectedCommonTags" name="common_tags" value="" />
    <input type="hidden" id="selectedUser" name="user" value="" />
    <!-- Button to open modal for selecting filters -->
    <button type="button" id="openTagModalBtn" class="filter-toggle">
      <i class="fas fa-filter"></i> Filters
    </button>
  </div>
  <!-- Display a summary of currently selected filters (optional) -->
  <div id="selectedTagDisplay" class="mt-2 text-light bottom_margin"></div>
  <button type="button" class="btn btn-secondary btn-sm" id="removeAllTags">Remove Filters</button>
</div>

<!-- Single Grid Container -->
<div class="image-grid">
  {% for screenshot in screenshots %}
    <div class="grid-item loading"
         data-user="{{ screenshot['uploader_name'] }}"
         data-tags="{{ screenshot['tags'] or '' }}"
         data-date="{{ screenshot['upload_date'] or '' }}"
         data-group="{{ screenshot['group_name'] or '' }}">
      <!-- The screenshot image -->
      <img src="{{ url_for('static', filename='images/' + screenshot['filename']) }}"
           alt="Shot by {{ screenshot['uploader_name'] }}"
           loading="lazy"
           onload="this.parentElement.classList.remove('loading')" />

      <!-- Info overlay -->
      <div class="image-info">
        {% if screenshot.group_name %}
          <p class="group fancy-text">{{ screenshot.group_name }}</p>
        {% endif %}

        {% if screenshot.tags %}
            <div class="tags">
                {% for tag in screenshot.tags %}
                    <span class="tag_badge bg-pill">#{{ tag }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <p class="username bold underline">
          @{{ screenshot.uploader_name }}
          <i class="fa-regular fa-user small no-round tiny-padding"></i>
        </p>

        <nav class="auto-width">
          <div class="image-actions tiny-padding">
            {% if session.get('username') == screenshot.uploader_name or user_role in ['admin', 'moderator'] %}
              <form action="{{ url_for('delete_image', filename=screenshot.filename) }}"
                    method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            {% endif %}
            <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#reportModal-{{ screenshot.id }}">
              Report
            </button>
          </div>
        </nav>
      </div>
    </div>

    <!-- Report Modal for this screenshot -->
    <div class="modal fade" id="reportModal-{{ screenshot.id }}" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel-{{ screenshot.id }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="reportModalLabel-{{ screenshot.id }}">Report Image</h5>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form action="{{ url_for('report_image', filename=screenshot.filename) }}" method="POST">
            <div class="modal-body">
              <div class="form-group">
                <label for="reason-{{ screenshot.id }}" class="font-weight-bold">Reason for Report</label>
                <textarea class="form-control" name="reason" id="reason-{{ screenshot.id }}" rows="3" required></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary btn-sm">Submit Report</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Lightbox (unchanged) -->
<div class="lightbox">
  <div class="close-lightbox">
    <i class="fas fa-times"></i>
  </div>
  <div class="lightbox-nav lightbox-prev">
    <i class="fas fa-chevron-left"></i>
  </div>
  <img src="" alt="Enlarged view" />
  <div class="lightbox-nav lightbox-next">
    <i class="fas fa-chevron-right"></i>
  </div>
  <div class="lightbox-info"></div>
</div>

<!-- JavaScript for Modal Tag & User Selection and URL-Based Filtering -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selectedTagIds = new Set();
    let selectedUser = null;
  
    const preapprovedTags = [
      {% for tag in preapproved_tags %}
        { id: "{{ tag['id'] }}", name: "{{ tag['name'] }}" }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
  
    const availableUsers = [
      {% for user in users %}
        "{{ user }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
  
    function updateBubbles(container, items, selectedItems, filter = '', type = 'tag') {
      container.innerHTML = '';
      items.forEach(item => {
        const itemValue = type === 'tag' ? item.name : item;
        if (itemValue.toLowerCase().includes(filter.toLowerCase())) {
          const bubble = document.createElement('div');
          bubble.classList.add(`${type}-bubble`);
          bubble.setAttribute('data-id', type === 'tag' ? item.id : item);
          bubble.textContent = itemValue;
          
          if (type === 'tag' && selectedItems.has(String(item.id)) ||
              type === 'user' && selectedItems === itemValue) {
            bubble.classList.add('selected');
          }
  
          bubble.addEventListener('click', () => {
            if (type === 'tag') {
              const tagId = bubble.getAttribute('data-id');
              if (selectedItems.has(String(tagId))) {
                selectedItems.delete(String(tagId));
              } else {
                selectedItems.add(String(tagId));
              }
            } else {
              selectedUser = selectedUser === itemValue ? null : itemValue;
            }
            updateBubbles(container, items, type === 'tag' ? selectedItems : selectedUser, filter, type);
          });
          
          container.appendChild(bubble);
        }
      });
    }
  
    function initializeFilters() {
      const urlParams = new URLSearchParams(window.location.search);
      const tagsParam = urlParams.get("tags");
      const userParam = urlParams.get("user");
  
      if (tagsParam) {
        tagsParam.split(",").forEach(id => selectedTagIds.add(id.trim()));
        document.getElementById("selectedCommonTags").value = tagsParam;
      }
  
      if (userParam) {
        selectedUser = userParam;
        document.getElementById("selectedUser").value = userParam;
      }
  
      updateFilterDisplay();
    }
  
    function updateFilterDisplay() {
      const tagDisplay = document.getElementById("selectedTagDisplay");
      const selectedTags = Array.from(selectedTagIds)
        .map(id => preapprovedTags.find(t => String(t.id) === id)?.name)
        .filter(Boolean);
      
      tagDisplay.innerHTML = [
        ...selectedTags,
        selectedUser
      ].filter(Boolean).join(" | ") || "<em>No filters selected</em>";
    }
  
    function applyFilters() {
      const params = new URLSearchParams();
      if (selectedTagIds.size) params.set("tags", Array.from(selectedTagIds).join(","));
      if (selectedUser) params.set("user", selectedUser);
  
      const newUrl = window.location.pathname + (params.toString() ? `?${params.toString()}` : '');
      window.location.href = newUrl;
    }
  
    // Event Listeners
    document.getElementById("tagSearch").addEventListener("input", function() {
      updateBubbles(
        document.getElementById('tagBubbleContainer'),
        preapprovedTags,
        selectedTagIds,
        this.value,
        'tag'
      );
    });
  
    document.getElementById("userSearch").addEventListener("input", function() {
      updateBubbles(
        document.getElementById('userBubbleContainer'),
        availableUsers,
        selectedUser,
        this.value,
        'user'
      );
    });
  
    document.getElementById("deselectAllBtn").addEventListener("click", () => {
      selectedTagIds.clear();
      selectedUser = null;
      updateBubbles(document.getElementById('tagBubbleContainer'), preapprovedTags, selectedTagIds, '', 'tag');
      updateBubbles(document.getElementById('userBubbleContainer'), availableUsers, selectedUser, '', 'user');
    });
  
    document.getElementById("saveFilterSelection").addEventListener("click", () => {
      $("#tagModal").modal("hide");
      applyFilters();
    });
  
    document.getElementById("removeAllTags").addEventListener("click", () => {
      selectedTagIds.clear();
      selectedUser = null;
      window.location.href = window.location.pathname;
    });
  
    document.getElementById("openTagModalBtn").addEventListener("click", () => {
      updateBubbles(document.getElementById('tagBubbleContainer'), preapprovedTags, selectedTagIds, '', 'tag');
      updateBubbles(document.getElementById('userBubbleContainer'), availableUsers, selectedUser, '', 'user');
      $("#tagModal").modal("show");
    });
  
    initializeFilters();
  });
</script>
{% endblock %}

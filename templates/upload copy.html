<!-- templates/upload.html -->
{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card text-light bg-dark">
                <div class="card-header blur">
                    <h4 class="mb-0 pricedown">Upload Screenshots</h4>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    <form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="group_name">Discord Username</label>
                            <div class="field textarea label prefix border round min show-overflow">
                                <input type="text"
                                    class="form-control bg-dark text-light field textarea border round min"
                                    data-lt-tmp-id="lt-517853"
                                    spellcheck="false"
                                    data-gramm="false"
                                    id="discord_username"
                                    name="discord_username"
                                    placeholder="Discord Username"
                                    required>
                            </div>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="group_name">Group Theme (Optional)</label>
                            <input type="text" 
                                class="form-control bg-dark text-light field textarea border round min" 
                                id="group_name" 
                                name="group_name"
                                placeholder="Enter a group theme">
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="tags">Feature Tags (comma-separated)</label>
                            <input type="text" 
                                class="form-control bg-dark text-light field textarea border round min" 
                                id="tags" 
                                name="tags"
                                placeholder="nve, quantv, cars, landscape, etc.">
                        </div>
                        
                        <div class="form-group mt-3 no-scroll">
                            <label for="screenshots" class="responsive fill border drophere">Select Images</label>
                            <h4>Drop up to 20 screenshots here or click to upload</h4>
                            <p class="text-muted">Supported formats: PNG, JPG, JPEG, WEBP, Max 10MB per Image</p>
                            <input type="file" 
                                class="form-control bg-dark text-light mt-4 rounded border" 
                                id="screenshots" 
                                name="screenshots[]" 
                                multiple 
                                accept=".png,.jpg,.jpeg,.webp"
                                required>
                        </div>
                        <button type="submit" class="responsive fill round border" id="submitButton">
                            <i class="no-round me-2">upload</i>Upload Screenshots
                        </button>
                        <div id="preview" class="mt-3">
                            <!-- Previews will appear here -->
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('screenshots').addEventListener('change', function(e) {
        const preview = document.getElementById('preview');
        preview.innerHTML = ''; // Clear existing previews
        
        for (const file of this.files) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `
                        <img src="${e.target.result}" 
                            alt="Preview" 
                            style="max-height: 200px; max-width: 100%; object-fit: contain;">
                    `;
                    preview.appendChild(div);
                }
                reader.readAsDataURL(file);
            }
        }
    });
    </script>
    <script>
    const uploadForm = new Dropzone("#uploadForm", {
        url: "{{ url_for('upload') }}",
        paramName: "screenshots[]",
        maxFiles: 10,
        maxFilesize: 10,
        acceptedFiles: ".png,.jpg,.jpeg,.webp",
        autoProcessQueue: false,
        uploadMultiple: true,
        createImageThumbnails: true,
        
        init: function() {
            const submitButton = document.getElementById('submitButton');
            const myDropzone = this;
    
            // Enable submit button when files are added
            this.on("addedfile", function() {
                if (this.files.length > 0) {
                    submitButton.disabled = false;
                }
            });
            
            // Disable submit button when all files are removed
            this.on("removedfile", function() {
                if (this.files.length === 0) {
                    submitButton.disabled = true;
                }
            });
            
            // Handle form submission
            document.getElementById('uploadForm').addEventListener("submit", function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Validate form
                const username = document.getElementById('discord_username').value;
                if (!username) {
                    alert('Please enter your Discord username');
                    return;
                }
                
                if (myDropzone.files.length === 0) {
                    alert('Please add at least one file');
                    return;
                }
                
                myDropzone.processQueue();
            });
    
            // Success handling
            this.on("success", function(files, response) {
                if (response.success) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success';
                    alert.textContent = response.message;
                    document.querySelector('.card-body').insertBefore(alert, document.querySelector('form'));
                    
                    // Reset form after success
                    setTimeout(() => {
                        this.removeAllFiles();
                        document.getElementById('uploadForm').reset();
                        alert.remove();
                        submitButton.disabled = true;
                    }, 2000);
                }
            });
            
            this.on("error", function(file, message) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                alert.textContent = message;
                document.querySelector('.card-body').insertBefore(alert, document.querySelector('form'));
            });
            
            this.on("addedfile", function(file) {
                // Preview the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    preview.innerHTML = `<img src="${e.target.result}" class="img-fluid" alt="Preview">`;
                }
                reader.readAsDataURL(file);
            });
        }
    });
    </script>
{% endblock %}